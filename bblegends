-- Project Infra UI for Basketball Legends
-- Developer: xylo

local Players = game:GetService("Players")
local UIS = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")

local LocalPlayer = Players.LocalPlayer
local playerTeam = LocalPlayer.Team
local Character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
local Humanoid = Character:WaitForChild("Humanoid")
local humanoidRootPart = Character:WaitForChild("HumanoidRootPart")

local bar = LocalPlayer.PlayerGui.Visual.Shooting.Bar
local overlay = bar.Overlay
local text = LocalPlayer.PlayerGui.Visual.ShotInfo.Timing.Title

local isActive = false
local autoGrabEnabled = false
local lastPosition = nil
local isFollowing = false
local nearestPlayer = nil
local speed = 0.01
local speedEnabled = false

-- UI helpers
local function section(tab, title)
    return tab:Section({ Title = title })
end

local function toggle(tab, title, desc, default, callback)
    return tab:Toggle({
        Title = title,
        Desc = desc or "",
        Value = default or false,
        Callback = callback
    })
end

local function button(tab, title, desc, callback)
    return tab:Button({
        Title = title,
        Desc = desc or "",
        Callback = callback
    })
end

local function slider(tab, title, desc, min, max, default, callback)
    return tab:Slider({
        Title = title,
        Desc = desc or "",
        Value = { Min = min, Max = max, Default = default },
        Callback = callback
    })
end

local function keybind(tab, title, desc, key, callback)
    return tab:Keybind({
        Title = title,
        Desc = desc or "",
        Value = key,
        Callback = callback
    })
end

-- Tabs
local Tabs = {
    Match   = Window:Tab({ Title = "Match",   Icon = "volleyball" }),
    Player  = Window:Tab({ Title = "Player",  Icon = "user" }),
    Credits = Window:Tab({ Title = "Credits", Icon = "script" }),
}
Window:SelectTab(1)

-- Credits tab
local creditsSection = section(Tabs.Credits, "Developer Info")
creditsSection:Label("Project Infra - Basketball Legends")
creditsSection:Label("Developer: xylo")
button(Tabs.Credits, "Join Discord", "Copy invite link", function()
    setclipboard("https://discord.gg/5EJmv76J")
end)
toggle(Tabs.Credits, "Show Glow", "Toggle UI glow effect", false, function(state)
    print("Glow state:", state)
end)

-- Match tab: Timing
local timingSection = section(Tabs.Match, "Timing")
toggle(Tabs.Match, "All Perfect", "Makes your shots all green.", false, function(Value)
    isActive = Value
end)

local function activatePerfect()
    bar.Size = UDim2.new(1, 0, 1, 0)
    overlay.Size = UDim2.new(1, 0, 1, 0)
    text.Text = "PERFECT"
    text.TextColor3 = Color3.fromRGB(0, 255, 0)
end

bar:GetPropertyChangedSignal("Size"):Connect(function()
    if isActive then
        bar.Size = UDim2.new(1, 0, 1, 0)
        overlay.Size = UDim2.new(1, 0, 1, 0)
    end
end)

UIS.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then return end
    if isActive and input.KeyCode == Enum.KeyCode.E then
        activatePerfect()
    end
end)

-- Match tab: Ball
local function grabBall()
    local char = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
    if not char or not char:FindFirstChild("HumanoidRootPart") or not char:FindFirstChild("Humanoid") then return end

    local messageLabel = LocalPlayer.PlayerGui.Visual.MessageBar.Title
    local messageText = messageLabel.Text:lower()
    if messageText:find("scored") and messageLabel.TextTransparency == 0 then return end

    local hrp = char.HumanoidRootPart
    local humanoid = char.Humanoid
    local ball = Workspace:FindFirstChild("Basketball")

    if ball and ball:IsA("BasePart") then
        lastPosition = hrp.Position
        humanoid.PlatformStand = true
        hrp.CFrame = ball.CFrame + Vector3.new(0, 3, 0)
        task.wait(0.2)
        hrp.CFrame = CFrame.new(lastPosition)
        humanoid.PlatformStand = false
    end
end

section(Tabs.Match, "Ball")
button(Tabs.Match, "Grab Ball", "Teleport to ball and back", function()
    grabBall()
end)
toggle(Tabs.Match, "Auto Grab Ball", "Automatically grab ball when grounded", false, function(Value)
    autoGrabEnabled = Value
end)

local Ground = Workspace:WaitForChild("Game"):WaitForChild("Court"):WaitForChild("Ground")
Workspace.ChildAdded:Connect(function(child)
    if child.Name == "Basketball" and child:IsA("BasePart") then
        child.Touched:Connect(function(hit)
            if autoGrabEnabled and hit == Ground then
                task.wait(0.05)
                grabBall()
            end
        end)
    end
end)

-- Match tab: Defense
section(Tabs.Match, "Defense")
keybind(Tabs.Match, "Auto Guard", "Follow nearest enemy", "B", function()
    isFollowing = not isFollowing
end)

local function findNearestPlayer()
    local shortestDistance = math.huge
    nearestPlayer = nil
    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= LocalPlayer and player.Character and player.Character:FindFirstChild("HumanoidRootPart") and player.Team and playerTeam and player.Team.Name ~= playerTeam.Name then
            local targetHRP = player.Character.HumanoidRootPart
            local distance = (targetHRP.Position - humanoidRootPart.Position).Magnitude
            if distance < shortestDistance then
                shortestDistance = distance
                nearestPlayer = player
            end
        end
    end
end

local function followPlayer(player)
    if player and player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
        local targetHRP = player.Character.HumanoidRootPart
        local lookDirection = targetHRP.CFrame.LookVector
        local offsetDistance = 2
        local desiredPosition = targetHRP.Position - lookDirection * offsetDistance
        Humanoid:MoveTo(desiredPosition)
    end
end

RunService.Heartbeat:Connect(function()
    if isFollowing then
        findNearestPlayer()
        followPlayer(nearestPlayer)
    end
end)

toggle(Tabs.Match, "Always Guard (Not Recommended)", "Force guard position", false, function(Value)
    if Value then
        ReplicatedStorage.Packages.Knit.Services.ControlService.RE.Guard:FireServer(true)
        task.wait(0.8)
    end
end)

-- Player tab: Speed
section(Tabs.Player, "Player Speed")
toggle(Tabs.Player, "Speed Boost", "Enable speed hack", false, function(Value)
    speedEnabled = Value
end)
slider(Tabs.Player, "WalkSpeed", "Adjust player speed", 1, 5, 1, function(Value)
    speed = Value / 100
end)

RunService.RenderStepped:Connect(function()
    local char = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
    if speedEnabled and char and char:FindFirstChild("HumanoidRootPart") then
        local hrp = char.HumanoidRootPart
        local moveDir = char.Humanoid.MoveDirection
        if moveDir.Magnitude > 0 then
            hrp.CFrame = hrp.CFrame + (moveDir * speed)
        end
    end
end)
